<ion-menu menuId="reports-menu" contentId="reports-content" side="start" type="overlay">
  <ion-header>
    <ion-toolbar color="primary">
      <ion-title>Reports</ion-title>
    </ion-toolbar>
  </ion-header>
  <ion-content>
    <ion-list>
      <ion-list-header>
        <ion-label>Report Types</ion-label>
      </ion-list-header>
      <ion-item button detail="false" (click)="selectReport('sales')" menuClose>
        <ion-icon name="trending-up" slot="start"></ion-icon>
        <ion-label>Sales Summary</ion-label>
      </ion-item>
      <ion-item button detail="false" (click)="selectReport('items')" menuClose>
        <ion-icon name="cart" slot="start"></ion-icon>
        <ion-label>Item Sales</ion-label>
      </ion-item>
      <ion-item button detail="false" (click)="selectReport('payments')" menuClose>
        <ion-icon name="cash" slot="start"></ion-icon>
        <ion-label>Payments</ion-label>
      </ion-item>
      <ion-item button detail="false" (click)="selectReport('inventory')" menuClose>
        <ion-icon name="cube" slot="start"></ion-icon>
        <ion-label>Inventory</ion-label>
      </ion-item>
      <ion-item button detail="false" (click)="selectReport('customers')" menuClose>
        <ion-icon name="people" slot="start"></ion-icon>
        <ion-label>Customers</ion-label>
      </ion-item>
      <ion-item button detail="false" (click)="selectReport('voids')" menuClose>
        <ion-icon name="close-circle" slot="start"></ion-icon>
        <ion-label>Voids</ion-label>
      </ion-item>
      <ion-item button detail="false" (click)="selectReport('workperiods')" menuClose>
        <ion-icon name="analytics" slot="start"></ion-icon>
        <ion-label>Workperiods</ion-label>
      </ion-item>
    </ion-list>
  </ion-content>
</ion-menu>

<ion-header class="reports-header" [translucent]="true">
  <ion-toolbar color="primary">
    <ion-button slot="start" fill="clear" (click)="openMenu()">
      <ion-icon name="menu"></ion-icon>
    </ion-button>
    <ion-title>Reports & Analytics</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="openReportsMenu()">
        <ion-icon name="list-outline"></ion-icon>
      </ion-button>
      <ion-button fill="clear" (click)="exportReport()">
        <ion-icon name="download"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Period Filter -->
  <ion-toolbar class="reports-nav-toolbar">
    <ion-segment [value]="selectedPeriod()" (ionChange)="selectPeriod($any($event.detail.value))" scrollable>
      <ion-segment-button value="today">
        <ion-label>Today</ion-label>
      </ion-segment-button>
      <ion-segment-button value="yesterday">
        <ion-label>Yesterday</ion-label>
      </ion-segment-button>
      <ion-segment-button value="thisWeek">
        <ion-label>This Week</ion-label>
      </ion-segment-button>
      <ion-segment-button value="lastWeek">
        <ion-label>Last Week</ion-label>
      </ion-segment-button>
      <ion-segment-button value="thisMonth">
        <ion-label>This Month</ion-label>
      </ion-segment-button>
      <ion-segment-button value="lastMonth">
        <ion-label>Last Month</ion-label>
      </ion-segment-button>
      <ion-segment-button value="thisYear">
        <ion-label>This Year</ion-label>
      </ion-segment-button>
      <ion-segment-button value="lastYear">
        <ion-label>Last Year</ion-label>
      </ion-segment-button>
      <ion-segment-button value="custom">
        <ion-icon name="calendar"></ion-icon>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>

  <!-- Standard Filters -->
  <ion-toolbar class="reports-nav-toolbar">
    <ion-segment [value]="paymentFilter()" (ionChange)="paymentFilter.set($any($event.detail.value))" scrollable>
      <ion-segment-button value="all">
        <ion-label>All Payments</ion-label>
      </ion-segment-button>
      <ion-segment-button value="cash">
        <ion-label>Cash</ion-label>
      </ion-segment-button>
      <ion-segment-button value="card">
        <ion-label>Card</ion-label>
      </ion-segment-button>
      <ion-segment-button value="mobile">
        <ion-label>Mobile</ion-label>
      </ion-segment-button>
      <ion-segment-button value="account">
        <ion-label>Account</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" id="reports-content">
  @if (isLoading()) {
    <div class="loading-state">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p>Loading report data...</p>
    </div>
  } @else {
    
    <!-- Sales Report -->
    @if (selectedReport() === 'sales') {
      <div class="reports-container">
        <div class="report-actions">
          <ion-button fill="clear" size="small" (click)="printCurrentReport()">
            <ion-icon name="print-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
        
        <!-- Summary Cards -->
        <div class="summary-grid">
          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="cash" color="success"></ion-icon>
                <div class="stat-info">
                  <small>Total Sales</small>
                  <h2>ZMW {{ salesSummary().totalSales | number:'1.2-2' }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="cart" color="primary"></ion-icon>
                <div class="stat-info">
                  <small>Total Orders</small>
                  <h2>{{ salesSummary().totalOrders }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="analytics" color="primary"></ion-icon>
                <div class="stat-info">
                  <small>Avg Order</small>
                  <h2>ZMW {{ salesSummary().averageOrderValue | number:'1.2-2' }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="trending-up" color="warning"></ion-icon>
                <div class="stat-info">
                  <small>Total Tax</small>
                  <h2>ZMW {{ salesSummary().totalTax | number:'1.2-2' }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </div>

        <!-- Sales Trend Chart -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Sales Trend</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="chart-container">
              <canvas #salesChart></canvas>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Top Products Chart -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Top Products by Revenue</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="chart-container">
              <canvas #productsChart></canvas>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Top Products List -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Best Sellers</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              @for (product of topProducts(); track product.name; let i = $index) {
                <ion-item lines="full">
                  <ion-label>
                    <h3>{{ i + 1 }}. {{ product.name }}</h3>
                    <p>{{ product.quantity }} units sold</p>
                  </ion-label>
                  <ion-text slot="end" color="primary">
                    <strong>ZMW {{ product.revenue | number:'1.2-2' }}</strong>
                  </ion-text>
                </ion-item>
              }
            </ion-list>
          </ion-card-content>
        </ion-card>
      </div>
    }

    <!-- Inventory Report -->
    @if (selectedReport() === 'inventory') {
      <div class="reports-container">
        <div class="report-actions">
          <ion-button fill="clear" size="small" (click)="printCurrentReport()">
            <ion-icon name="print-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
        
        <!-- Inventory Summary -->
        <div class="summary-grid">
          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="cube" color="primary"></ion-icon>
                <div class="stat-info">
                  <small>Total Products</small>
                  <h2>{{ productsService.products().length }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="cash" color="success"></ion-icon>
                <div class="stat-info">
                  <small>Inventory Value</small>
                  <h2>ZMW {{ totalInventoryValue() | number:'1.2-2' }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="alert-circle" color="warning"></ion-icon>
                <div class="stat-info">
                  <small>Low Stock Items</small>
                  <h2>{{ lowStockProducts().length }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="albums" color="primary"></ion-icon>
                <div class="stat-info">
                  <small>Categories</small>
                  <h2>{{ productsService.categories().length }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </div>

        <!-- Category Distribution -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Inventory by Category</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="chart-container">
              <canvas #categoryChart></canvas>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Low Stock Alert -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Low Stock Alert</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (lowStockProducts().length === 0) {
              <ion-text color="success">
                <p>All products are well stocked!</p>
              </ion-text>
            } @else {
              <ion-list>
                @for (product of lowStockProducts(); track product._id) {
                  <ion-item lines="full">
                    <ion-label>
                      <h3>{{ product.name }}</h3>
                      <p>{{ product.unit }}</p>
                    </ion-label>
                    <ion-badge 
                      slot="end" 
                      [color]="product.quantity === 0 ? 'danger' : 'warning'"
                    >
                      {{ product.quantity }} left
                    </ion-badge>
                  </ion-item>
                }
              </ion-list>
            }
          </ion-card-content>
        </ion-card>

        <!-- Stock Adjustments (Variance) -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Stock Adjustments</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="variance-summary">
              <div class="variance-stat">
                <small>Net Quantity</small>
                <h3 [style.color]="inventoryVarianceSummary().netQuantity >= 0 ? 'green' : 'red'">
                  {{ inventoryVarianceSummary().netQuantity > 0 ? '+' : '' }}{{ inventoryVarianceSummary().netQuantity }}
                </h3>
              </div>
              <div class="variance-stat">
                <small>Net Value</small>
                <h3 [style.color]="inventoryVarianceSummary().netValue >= 0 ? 'green' : 'red'">
                  {{ inventoryVarianceSummary().netValue >= 0 ? '+' : '' }}ZMW {{ inventoryVarianceSummary().netValue | number:'1.2-2' }}
                </h3>
              </div>
            </div>

            @if (inventoryVariance().length === 0) {
              <ion-text color="medium">
                <p>No adjustments recorded for this period.</p>
              </ion-text>
            } @else {
              <ion-list>
                @for (row of inventoryVariance(); track row.productId) {
                  <ion-item lines="full">
                    <ion-label>
                      <h3>{{ row.name }}</h3>
                      <p>
                        Qty: {{ row.netQuantity > 0 ? '+' : '' }}{{ row.netQuantity }}
                      </p>
                    </ion-label>
                    <ion-text slot="end" [color]="row.netValue >= 0 ? 'success' : 'danger'">
                      <strong>
                        {{ row.netValue >= 0 ? '+' : '' }}ZMW {{ row.netValue | number:'1.2-2' }}
                      </strong>
                    </ion-text>
                  </ion-item>
                }
              </ion-list>
            }
          </ion-card-content>
        </ion-card>
      </div>
    }

    <!-- Item Sales Report -->
    @if (selectedReport() === 'items') {
      <div class="reports-container">
        <div class="report-actions">
          <ion-button fill="clear" size="small" (click)="printCurrentReport()">
            <ion-icon name="print-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>

        <ion-card>
          <ion-card-header>
            <ion-card-title>Item Sales</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (itemSales().length === 0) {
              <ion-text color="medium">
                <p>No item sales for the selected period and filters.</p>
              </ion-text>
            } @else {
              <ion-list>
                @for (row of itemSales(); track row.productId) {
                  <ion-item lines="full">
                    <ion-label>
                      <h3>{{ row.name }}</h3>
                      <p>
                        Qty: {{ row.quantity }} •
                        Avg: ZMW {{ row.avgPrice | number:'1.2-2' }}
                      </p>
                    </ion-label>
                    <div slot="end" class="item-metrics">
                      <ion-text color="primary">
                        <strong>ZMW {{ row.revenue | number:'1.2-2' }}</strong>
                      </ion-text>
                      <ion-text [color]="row.margin >= 0 ? 'success' : 'danger'">
                        <small>
                          Margin: ZMW {{ row.margin | number:'1.2-2' }}
                          ({{ (row.marginRate * 100) | number:'1.0-1' }}%)
                        </small>
                      </ion-text>
                    </div>
                  </ion-item>
                }
              </ion-list>
            }
          </ion-card-content>
        </ion-card>
      </div>
    }

    <!-- Payments Report -->
    @if (selectedReport() === 'payments') {
      <div class="reports-container">
        <div class="report-actions">
          <ion-button fill="clear" size="small" (click)="printCurrentReport()">
            <ion-icon name="print-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>

        <ion-card>
          <ion-card-header>
            <ion-card-title>Payment Summary</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (paymentSummary().length === 0) {
              <ion-text color="medium">
                <p>No payments for the selected period and filters.</p>
              </ion-text>
            } @else {
              <ion-list>
                @for (row of paymentSummary(); track row.type) {
                  <ion-item lines="full">
                    <ion-label>
                      <h3>{{ row.type | uppercase }}</h3>
                      <p>
                        Payments: {{ row.paymentCount }} •
                        Orders: {{ row.orderCount }}
                      </p>
                    </ion-label>
                    <ion-text slot="end" color="primary">
                      <strong>ZMW {{ row.totalAmount | number:'1.2-2' }}</strong>
                    </ion-text>
                  </ion-item>
                }
              </ion-list>
            }
          </ion-card-content>
        </ion-card>
      </div>
    }

    <!-- Customer Report -->
    @if (selectedReport() === 'customers') {
      <div class="reports-container">
        <div class="report-actions">
          <ion-button fill="clear" size="small" (click)="printCurrentReport()">
            <ion-icon name="print-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
        
        <!-- Customer Summary -->
        <div class="summary-grid">
          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="people" color="primary"></ion-icon>
                <div class="stat-info">
                  <small>Total Customers</small>
                  <h2>{{ customersService.customers().length }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="checkmark-circle" color="success"></ion-icon>
                <div class="stat-info">
                  <small>Active</small>
                  <h2>{{ customersService.activeCustomers().length }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="card" color="warning"></ion-icon>
                <div class="stat-info">
                  <small>With Credit</small>
                  <h2>{{ customersWithCredit().length }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="cash" color="danger"></ion-icon>
                <div class="stat-info">
                  <small>Outstanding</small>
                  <h2>ZMW {{ totalOutstanding() | number:'1.2-2' }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </div>

        <!-- Top Customers -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Top Customers</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (topCustomers().length === 0) {
              <ion-text color="medium">
                <p>No customer data available for selected period</p>
              </ion-text>
            } @else {
              <ion-list>
                @for (customer of topCustomers(); track customer.phone; let i = $index) {
                  <ion-item lines="full">
                    <ion-label>
                      <h3>{{ i + 1 }}. {{ customer.name }}</h3>
                      <p>{{ customer.phone }} • {{ customer.orderCount }} orders</p>
                    </ion-label>
                    <ion-text slot="end" color="primary">
                      <strong>ZMW {{ customer.totalSpent | number:'1.2-2' }}</strong>
                    </ion-text>
                  </ion-item>
                }
              </ion-list>
            }
          </ion-card-content>
        </ion-card>

        <!-- Customers with Outstanding Balance -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Customers with Credit Balance</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (customersWithCredit().length === 0) {
              <ion-text color="success">
                <p>No outstanding credit balances!</p>
              </ion-text>
            } @else {
              <ion-list>
                @for (customer of customersWithCredit(); track customer._id) {
                  <ion-item lines="full">
                    <ion-label>
                      <h3>{{ customer.name }}</h3>
                      <p>{{ customer.phone }}</p>
                    </ion-label>
                    <ion-text slot="end" color="danger">
                      <strong>ZMW {{ customer.balance | number:'1.2-2' }}</strong>
                    </ion-text>
                  </ion-item>
                }
              </ion-list>
            }
          </ion-card-content>
        </ion-card>
      </div>
    }

    <!-- Workperiod Report -->
    @if (selectedReport() === 'workperiods') {
      <div class="reports-container">
        <div class="report-actions">
          <ion-button fill="clear" size="small" (click)="printCurrentReport()">
            <ion-icon name="print-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>

        <!-- Current / Selected Workperiod Summary -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Workperiod Summary</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (getSelectedWorkperiod()) {
              <p>
                <strong>Status:</strong>
                <ion-badge [color]="getSelectedWorkperiod()?.status === 'open' ? 'success' : 'medium'">
                  {{ getSelectedWorkperiod()?.status | uppercase }}
                </ion-badge>
              </p>
              <p>
                <strong>Opened by:</strong> {{ getSelectedWorkperiod()?.opened_by }}
              </p>
              <p>
                <strong>Start:</strong> {{ getSelectedWorkperiod()?.start_time | date:'short' }}
              </p>
              @if (getSelectedWorkperiod()?.end_time) {
                <p>
                  <strong>End:</strong> {{ getSelectedWorkperiod()?.end_time | date:'short' }}
                </p>
              }

              <div class="summary-grid">
                <ion-card class="summary-card">
                  <ion-card-content>
                    <div class="stat">
                      <ion-icon name="cash" color="success"></ion-icon>
                      <div class="stat-info">
                        <small>Total Sales</small>
                        <h2>ZMW {{ workperiodSalesSummary().totalSales | number:'1.2-2' }}</h2>
                      </div>
                    </div>
                  </ion-card-content>
                </ion-card>

                <ion-card class="summary-card">
                  <ion-card-content>
                    <div class="stat">
                      <ion-icon name="cart" color="primary"></ion-icon>
                      <div class="stat-info">
                        <small>Orders</small>
                        <h2>{{ workperiodSalesSummary().totalOrders }}</h2>
                      </div>
                    </div>
                  </ion-card-content>
                </ion-card>

                <ion-card class="summary-card">
                  <ion-card-content>
                    <div class="stat">
                      <ion-icon name="analytics" color="warning"></ion-icon>
                      <div class="stat-info">
                        <small>Avg Order</small>
                        <h2>ZMW {{ workperiodSalesSummary().averageOrderValue | number:'1.2-2' }}</h2>
                      </div>
                    </div>
                  </ion-card-content>
                </ion-card>

                <ion-card class="summary-card">
                  <ion-card-content>
                    <div class="stat">
                      <ion-icon name="close-circle" color="danger"></ion-icon>
                      <div class="stat-info">
                        <small>Voided Amount</small>
                        <h2>ZMW {{ workperiodVoidSummary().totalAmount | number:'1.2-2' }}</h2>
                      </div>
                    </div>
                  </ion-card-content>
                </ion-card>
              </div>
            } @else {
              <ion-text color="medium">
                <p>No workperiod selected. Open or select a workperiod below.</p>
              </ion-text>
            }
          </ion-card-content>
        </ion-card>

        <!-- Workperiod Controls & List -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Workperiods</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="workperiod-controls">
              @if (workperiodsService.currentWorkperiod()) {
                <ion-button color="danger" (click)="onCloseWorkperiodClick()">
                  Close Current Workperiod
                </ion-button>
              } @else {
                <ion-button color="primary" (click)="onOpenWorkperiodClick()">
                  Open New Workperiod
                </ion-button>
              }
            </div>

            @if (workperiodsService.recentWorkperiods().length === 0) {
              <ion-text color="medium">
                <p>No workperiods recorded yet.</p>
              </ion-text>
            } @else {
              <ion-list>
                @for (wp of workperiodsService.recentWorkperiods(); track wp.id) {
                  <ion-item lines="full" (click)="selectWorkperiod(wp)">
                    <ion-label>
                      <h3>
                        {{ wp.name || 'Workperiod' }}
                        <ion-badge [color]="wp.status === 'open' ? 'success' : 'medium'" class="wp-badge">
                          {{ wp.status | uppercase }}
                        </ion-badge>
                      </h3>
                      <p>
                        {{ wp.start_time | date:'short' }}
                        @if (wp.end_time) {
                          &nbsp;–&nbsp;{{ wp.end_time | date:'short' }}
                        }
                      </p>
                    </ion-label>
                  </ion-item>
                }
              </ion-list>
            }
          </ion-card-content>
        </ion-card>

        <!-- Workperiod Payment Breakdown -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Payment Breakdown (Workperiod)</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (workperiodPaymentSummary().length === 0) {
              <ion-text color="medium">
                <p>No payments recorded for this workperiod.</p>
              </ion-text>
            } @else {
              <ion-list>
                @for (row of workperiodPaymentSummary(); track row.type) {
                  <ion-item lines="full">
                    <ion-label>
                      <h3>{{ row.type | uppercase }}</h3>
                      <p>
                        Payments: {{ row.paymentCount }} •
                        Orders: {{ row.orderCount }}
                      </p>
                    </ion-label>
                    <ion-text slot="end" color="primary">
                      <strong>ZMW {{ row.totalAmount | number:'1.2-2' }}</strong>
                    </ion-text>
                  </ion-item>
                }
              </ion-list>
            }
          </ion-card-content>
        </ion-card>

        <!-- Workperiod Void Activity -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Void Activity (Workperiod)</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (workperiodVoids().length === 0) {
              <ion-text color="medium">
                <p>No voids recorded for this workperiod.</p>
              </ion-text>
            } @else {
              <ion-list>
                @for (v of workperiodVoids(); track v.id) {
                  <ion-item lines="full">
                    <ion-label>
                      <h3>{{ v.product_name }} (x{{ v.quantity }})</h3>
                      <p>
                        {{ v.created_by || 'Unknown' }} •
                        {{ v.created_at | date:'short' }}
                      </p>
                      @if (v.reason) {
                        <p>Reason: {{ v.reason }}</p>
                      }
                    </ion-label>
                    <ion-text slot="end" color="danger">
                      <strong>ZMW {{ v.total | number:'1.2-2' }}</strong>
                    </ion-text>
                  </ion-item>
                }
              </ion-list>
            }
          </ion-card-content>
        </ion-card>

        <!-- Waiter Performance -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Waiter Performance</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (waiterPerformance().length === 0) {
              <ion-text color="medium">
                <p>No waiter activity for this workperiod.</p>
              </ion-text>
            } @else {
              <ion-list>
                @for (row of waiterPerformance(); track row.waiterId) {
                  <ion-item lines="full">
                    <ion-label>
                      <h3>{{ row.waiterName }}</h3>
                      <p>
                        Orders: {{ row.orderCount }} • Guests: {{ row.covers || 0 }}
                      </p>
                    </ion-label>
                    <div slot="end" class="item-metrics">
                      <ion-text color="primary">
                        <strong>ZMW {{ row.totalSales | number:'1.2-2' }}</strong>
                      </ion-text>
                      <ion-text color="medium">
                        <small>
                          Avg/order: ZMW {{ row.averageOrderValue | number:'1.2-2' }}
                          • Avg/guest: ZMW {{ row.averagePerCover | number:'1.2-2' }}
                        </small>
                      </ion-text>
                    </div>
                  </ion-item>
                }
              </ion-list>
            }
          </ion-card-content>
        </ion-card>

        <!-- Table Performance -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Table Performance</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (tablePerformance().length === 0) {
              <ion-text color="medium">
                <p>No table activity for this workperiod.</p>
              </ion-text>
            } @else {
              <ion-list>
                @for (row of tablePerformance(); track row.tableId) {
                  <ion-item lines="full">
                    <ion-label>
                      <h3>{{ row.tableLabel }}</h3>
                      <p>
                        Orders: {{ row.orderCount }} • Guests: {{ row.covers || 0 }}
                      </p>
                    </ion-label>
                    <ion-text slot="end" color="primary">
                      <div class="item-metrics">
                        <ion-text color="primary">
                          <strong>ZMW {{ row.totalSales | number:'1.2-2' }}</strong>
                        </ion-text>
                        <ion-text color="medium">
                          <small>Avg/guest: ZMW {{ row.averagePerCover | number:'1.2-2' }}</small>
                        </ion-text>
                      </div>
                    </ion-text>
                  </ion-item>
                }
              </ion-list>
            }
          </ion-card-content>
        </ion-card>
      </div>
    }

    <!-- Void Report -->
    @if (selectedReport() === 'voids') {
      <div class="reports-container">
        <div class="report-actions">
          <ion-button fill="clear" size="small" (click)="printCurrentReport()">
            <ion-icon name="print-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>

        <!-- Void Summary -->
        <div class="summary-grid">
          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="close-circle" color="danger"></ion-icon>
                <div class="stat-info">
                  <small>Total Voided Amount</small>
                  <h2>ZMW {{ voidSummary().totalAmount | number:'1.2-2' }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="cart" color="warning"></ion-icon>
                <div class="stat-info">
                  <small>Voided Quantity</small>
                  <h2>{{ voidSummary().totalQuantity }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="analytics" color="primary"></ion-icon>
                <div class="stat-info">
                  <small>Void Actions</small>
                  <h2>{{ voidSummary().count }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card class="summary-card">
            <ion-card-content>
              <div class="stat">
                <ion-icon name="people" color="medium"></ion-icon>
                <div class="stat-info">
                  <small>Staff with Voids</small>
                  <h2>{{ voidsByUser().length }}</h2>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </div>

        <!-- Voids by Staff -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Voids by Staff</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (voidsByUser().length === 0) {
              <ion-text color="medium">
                <p>No voids recorded yet.</p>
              </ion-text>
            } @else {
              <ion-list>
                @for (row of voidsByUser(); track row.createdBy) {
                  <ion-item lines="full">
                    <ion-label>
                      <h3>{{ row.createdBy }}</h3>
                      <p>{{ row.count }} voids</p>
                    </ion-label>
                    <ion-text slot="end" color="danger">
                      <strong>ZMW {{ row.totalAmount | number:'1.2-2' }}</strong>
                    </ion-text>
                  </ion-item>
                }
              </ion-list>
            }
          </ion-card-content>
        </ion-card>

        <!-- Recent Void Actions -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>Recent Voids</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (voids().length === 0) {
              <ion-text color="medium">
                <p>No void activity to show.</p>
              </ion-text>
            } @else {
              <ion-list>
                @for (v of voids(); track v.id) {
                  <ion-item lines="full">
                    <ion-label>
                      <h3>{{ v.product_name }} (x{{ v.quantity }})</h3>
                      <p>
                        {{ v.created_by || 'Unknown' }} •
                        {{ v.created_at | date:'short' }}
                      </p>
                      @if (v.reason) {
                        <p>Reason: {{ v.reason }}</p>
                      }
                    </ion-label>
                    <ion-text slot="end" color="danger">
                      <strong>ZMW {{ v.total | number:'1.2-2' }}</strong>
                    </ion-text>
                  </ion-item>
                }
              </ion-list>
            }
          </ion-card-content>
        </ion-card>
      </div>
    }
  }
</ion-content>

<!-- Date Range Modal -->
<ion-modal [isOpen]="showDateModal()" (didDismiss)="showDateModal.set(false)">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Select Date Range</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="showDateModal.set(false)">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="ion-padding">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Start Date</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-datetime
            [(ngModel)]="startDate"
            presentation="date"
            [max]="endDate()"
          ></ion-datetime>
        </ion-card-content>
      </ion-card>

      <ion-card>
        <ion-card-header>
          <ion-card-title>End Date</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-datetime
            [(ngModel)]="endDate"
            presentation="date"
            [min]="startDate()"
          ></ion-datetime>
        </ion-card-content>
      </ion-card>

      <ion-button expand="block" (click)="applyDateFilter()">
        Apply Filter
      </ion-button>
    </ion-content>
  </ng-template>
</ion-modal>
