<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-button slot="start" fill="clear" (click)="openMenu()">
      <ion-icon name="menu"></ion-icon>
    </ion-button>
    <ion-title>Orders</ion-title>
  </ion-toolbar>

  <!-- Period Filter -->
  <ion-toolbar>
    <ion-segment [value]="selectedPeriod()" (ionChange)="selectPeriod($any($event.detail.value))">
      <ion-segment-button value="today">
        <ion-label>Today</ion-label>
      </ion-segment-button>
      <ion-segment-button value="week">
        <ion-label>Week</ion-label>
      </ion-segment-button>
      <ion-segment-button value="month">
        <ion-label>Month</ion-label>
      </ion-segment-button>
      <ion-segment-button value="custom">
        <ion-icon name="calendar"></ion-icon>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>

  <!-- Search -->
  <ion-toolbar>
    <ion-searchbar
      placeholder="Search by invoice, customer..."
      [debounce]="300"
      (ionInput)="onSearchChange($event)"
    ></ion-searchbar>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($any($event))">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Summary Cards -->
  <div class="summary-section">
    <ion-card class="summary-card">
      <ion-card-content>
        <div class="stat">
          <ion-text color="medium">
            <small>Total Sales</small>
          </ion-text>
          <h2>ZMW {{ summary().totalSales | number:'1.2-2' }}</h2>
        </div>
      </ion-card-content>
    </ion-card>

    <ion-card class="summary-card">
      <ion-card-content>
        <div class="stat">
          <ion-text color="medium">
            <small>Orders</small>
          </ion-text>
          <h2>{{ summary().totalOrders }}</h2>
        </div>
      </ion-card-content>
    </ion-card>

    <ion-card class="summary-card">
      <ion-card-content>
        <div class="stat">
          <ion-text color="medium">
            <small>Avg Order</small>
          </ion-text>
          <h2>ZMW {{ summary().averageOrder | number:'1.2-2' }}</h2>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Status Filter -->
  <div class="status-chips">
    <ion-chip
      [color]="statusFilter() === 'all' ? 'primary' : 'medium'"
      (click)="selectStatus('all')"
    >
      <ion-label>All</ion-label>
    </ion-chip>
    <ion-chip
      [color]="statusFilter() === 'completed' ? 'primary' : 'medium'"
      (click)="selectStatus('completed')"
    >
      <ion-label>Completed</ion-label>
    </ion-chip>
    <ion-chip
      [color]="statusFilter() === 'pending' ? 'primary' : 'medium'"
      (click)="selectStatus('pending')"
    >
      <ion-label>Pending</ion-label>
    </ion-chip>
    <ion-chip
      [color]="statusFilter() === 'cancelled' ? 'primary' : 'medium'"
      (click)="selectStatus('cancelled')"
    >
      <ion-label>Cancelled</ion-label>
    </ion-chip>
  </div>

  <!-- Orders List -->
  <ion-list class="orders-list">
    @if (isLoading()) {
      <div class="loading-state">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
        <p>Loading orders...</p>
      </div>
    } @else if (filteredOrders().length === 0) {
      <div class="empty-state">
        <ion-icon name="receipt" color="medium"></ion-icon>
        <h2>No orders found</h2>
        <p>No orders match your current filters</p>
      </div>
    } @else {
      @for (order of filteredOrders(); track order._id) {
        <ion-item button (click)="viewOrderDetails(order)" lines="full">
          <div class="order-item">
            <div class="order-header">
              <div class="order-info">
                <h3>{{ order.orderNumber || order.invoice_no }}</h3>
                <ion-text color="medium">
                  <p>{{ formatDate(order.createdAt) }}</p>
                </ion-text>
              </div>
              <div class="order-status">
                <ion-badge [color]="getStatusColor(order.status)">
                  {{ order.status }}
                </ion-badge>
              </div>
            </div>

            <div class="order-details">
              @if (order.customer) {
                <div class="detail">
                  <ion-icon name="person" color="medium"></ion-icon>
                  <span>{{ order.customer.name }}</span>
                </div>
              }
              
              <div class="detail">
                <ion-icon name="cart" color="medium"></ion-icon>
                <span>{{ order.items.length }} item(s)</span>
              </div>

              <div class="detail">
                <ion-icon name="card" color="medium"></ion-icon>
                <span>{{ getPaymentMethodLabel(order.paymentMethod || order.paymentOption) }}</span>
              </div>
            </div>

            <div class="order-footer">
              <ion-text color="primary">
                <h2>ZMW {{ order.total | number:'1.2-2' }}</h2>
              </ion-text>
              <ion-icon name="arrow-forward" color="medium"></ion-icon>
            </div>
          </div>
        </ion-item>
      }
    }
  </ion-list>
</ion-content>

<!-- Date Range Modal -->
<ion-modal [isOpen]="showDateModal()" (didDismiss)="showDateModal.set(false)">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Select Date Range</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="showDateModal.set(false)">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="ion-padding">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Start Date</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-datetime
            [(ngModel)]="startDate"
            presentation="date"
            [max]="endDate()"
          ></ion-datetime>
        </ion-card-content>
      </ion-card>

      <ion-card>
        <ion-card-header>
          <ion-card-title>End Date</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-datetime
            [(ngModel)]="endDate"
            presentation="date"
            [min]="startDate()"
          ></ion-datetime>
        </ion-card-content>
      </ion-card>

      <ion-button expand="block" (click)="applyDateFilter()">
        <ion-icon name="checkmark" slot="start"></ion-icon>
        Apply Filter
      </ion-button>
    </ion-content>
  </ng-template>
</ion-modal>
