<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-button slot="start" fill="clear" (click)="openMenu()">
      <ion-icon name="menu-outline"></ion-icon>
    </ion-button>
    <ion-title>Inventory Management</ion-title>
    <ion-button slot="end" fill="clear" (click)="scanBarcode()" [disabled]="isScanning()">
      @if (isScanning()) {
        <ion-spinner name="crescent"></ion-spinner>
      } @else {
        <ion-icon name="barcode-outline"></ion-icon>
      }
    </ion-button>
  </ion-toolbar>
  
  <!-- Segment for switching views -->
  <ion-toolbar>
    <ion-segment [value]="activeView()" (ionChange)="changeView($any($event.detail.value))">
      <ion-segment-button value="overview">
        <ion-label>Overview</ion-label>
      </ion-segment-button>
      <ion-segment-button value="adjustments">
        <ion-label>Adjustments</ion-label>
      </ion-segment-button>
      <ion-segment-button value="alerts">
        <ion-label>Alerts</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- OVERVIEW TAB -->
  @if (activeView() === 'overview') {
    <!-- Stats Cards -->
    <div class="stats-container">
      <ion-grid>
        <ion-row>
          <ion-col size="6" sizeMd="3">
            <ion-card class="stat-card">
              <ion-card-content>
                <div class="stat-icon">
                  <ion-icon name="cube-outline" color="primary"></ion-icon>
                </div>
                <div class="stat-value">{{ inventoryStats().totalItems }}</div>
                <div class="stat-label">Total Items</div>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <ion-card class="stat-card warning">
              <ion-card-content>
                <div class="stat-icon">
                  <ion-icon name="alert-circle-outline" color="warning"></ion-icon>
                </div>
                <div class="stat-value">{{ inventoryStats().lowStock }}</div>
                <div class="stat-label">Low Stock</div>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <ion-card class="stat-card danger">
              <ion-card-content>
                <div class="stat-icon">
                  <ion-icon name="close-circle-outline" color="danger"></ion-icon>
                </div>
                <div class="stat-value">{{ inventoryStats().outOfStock }}</div>
                <div class="stat-label">Out of Stock</div>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="6" sizeMd="3">
            <ion-card class="stat-card success">
              <ion-card-content>
                <div class="stat-icon">
                  <ion-icon name="cash-outline" color="success"></ion-icon>
                </div>
                <div class="stat-value">ZMW {{ inventoryStats().totalValue | number:'1.0-0' }}</div>
                <div class="stat-label">Stock Value</div>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>

    <!-- Search and Filter -->
    <div class="filters">
      <ion-searchbar
        placeholder="Search products..."
        [debounce]="300"
        (ionInput)="onSearchChange($event)"
      ></ion-searchbar>

      <div class="filter-chips">
        <ion-chip
          [color]="stockFilter() === 'all' ? 'primary' : 'medium'"
          (click)="setStockFilter('all')"
        >
          <ion-label>All Stock</ion-label>
        </ion-chip>
        <ion-chip
          [color]="stockFilter() === 'low' ? 'primary' : 'medium'"
          (click)="setStockFilter('low')"
        >
          <ion-label>Low Stock</ion-label>
        </ion-chip>
        <ion-chip
          [color]="stockFilter() === 'out' ? 'primary' : 'medium'"
          (click)="setStockFilter('out')"
        >
          <ion-label>Out of Stock</ion-label>
        </ion-chip>
      </div>
    </div>

    <!-- Inventory List -->
    <ion-list class="inventory-list">
      <ion-item *ngFor="let product of filteredProducts()" lines="full">
        <div class="inventory-item">
          <div class="item-main">
            <div class="item-info">
              <h3>{{ product.name }}</h3>
              <p class="meta">{{ product.barcode }}</p>
              <ion-chip [color]="getStockStatusColor(product)" size="small">
                <ion-label>{{ getStockStatusLabel(product) }}</ion-label>
              </ion-chip>
            </div>
            <div class="item-stock">
              <div class="quantity">
                <h2 [class.low]="product.quantity <= 10" [class.out]="product.quantity === 0">
                  {{ product.quantity }}
                </h2>
                <p>{{ product.unit || 'units' }}</p>
              </div>
              <div class="value">
                <p class="label">Value</p>
                <p class="amount">ZMW {{ (product.price * product.quantity) | number:'1.2-2' }}</p>
              </div>
            </div>
          </div>
          <div class="item-actions">
            <ion-button fill="outline" size="small" (click)="adjustStock(product, 'add')">
              <ion-icon name="add-outline" slot="start"></ion-icon>
              Add
            </ion-button>
            <ion-button fill="outline" size="small" (click)="adjustStock(product, 'remove')">
              <ion-icon name="remove-outline" slot="start"></ion-icon>
              Remove
            </ion-button>
            <ion-button fill="outline" size="small" color="medium" (click)="adjustStock(product, 'correct')">
              <ion-icon name="create-outline" slot="start"></ion-icon>
              Correct
            </ion-button>
          </div>
        </div>
      </ion-item>
    </ion-list>

    <!-- Empty State -->
    @if (filteredProducts().length === 0 && !isLoading()) {
      <div class="empty-state">
        <ion-icon name="cube-outline" color="medium"></ion-icon>
        <h2>No products found</h2>
        <p>Try adjusting your search or filter</p>
      </div>
    }
  }

  <!-- ADJUSTMENTS TAB -->
  @if (activeView() === 'adjustments') {
    <div class="adjustments-header">
      <ion-segment [value]="adjustmentFilter()" (ionChange)="setAdjustmentFilter($any($event.detail.value))">
        <ion-segment-button value="all">
          <ion-label>All</ion-label>
        </ion-segment-button>
        <ion-segment-button value="purchase">
          <ion-label>Purchase</ion-label>
        </ion-segment-button>
        <ion-segment-button value="sale">
          <ion-label>Sale</ion-label>
        </ion-segment-button>
        <ion-segment-button value="adjustment">
          <ion-label>Adjustment</ion-label>
        </ion-segment-button>
        <ion-segment-button value="return">
          <ion-label>Return</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <ion-list class="adjustments-list">
      <ion-item *ngFor="let adjustment of filteredAdjustments()" lines="full">
        <div class="adjustment-item">
          <div class="adjustment-header">
            <div class="product-name">
              <h3>{{ getProductName(adjustment.product) }}</h3>
              <p class="timestamp">{{ adjustment.createdAt | date:'short' }}</p>
            </div>
            <ion-badge [color]="getAdjustmentColor(adjustment.action)">
              {{ adjustment.action }}
            </ion-badge>
          </div>
          <div class="adjustment-details">
            <div class="quantity-change">
              <ion-text [color]="adjustment.quantity > 0 ? 'success' : 'danger'">
                <strong>{{ adjustment.quantity > 0 ? '+' : '' }}{{ adjustment.quantity }}</strong>
              </ion-text>
            </div>
            @if (adjustment.notes) {
              <p class="notes">{{ adjustment.notes }}</p>
            }
            @if (adjustment.reference) {
              <p class="reference">Ref: {{ adjustment.reference }}</p>
            }
          </div>
        </div>
      </ion-item>
    </ion-list>

    @if (filteredAdjustments().length === 0 && !isLoading()) {
      <div class="empty-state">
        <ion-icon name="swap-horizontal-outline" color="medium"></ion-icon>
        <h2>No adjustments found</h2>
        <p>Stock adjustments will appear here</p>
      </div>
    }
  }

  <!-- ALERTS TAB -->
  @if (activeView() === 'alerts') {
    <ion-list class="alerts-list">
      <ion-list-header>
        <ion-label>Low Stock Alerts</ion-label>
      </ion-list-header>

      <ion-item *ngFor="let product of lowStockProducts()" lines="full">
        <ion-icon name="alert-circle" slot="start" color="warning"></ion-icon>
        <ion-label>
          <h2>{{ product.name }}</h2>
          <p>Only {{ product.quantity }} {{ product.unit || 'units' }} remaining</p>
        </ion-label>
        <ion-button slot="end" fill="outline" size="small" (click)="adjustStock(product, 'add')">
          <ion-icon name="add-outline" slot="start"></ion-icon>
          Restock
        </ion-button>
      </ion-item>

      @if (lowStockProducts().length === 0) {
        <div class="empty-state">
          <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
          <h2>All good!</h2>
          <p>No low stock alerts at the moment</p>
        </div>
      }

      <ion-list-header>
        <ion-label>Out of Stock</ion-label>
      </ion-list-header>

      <ion-item *ngFor="let product of outOfStockProducts()" lines="full">
        <ion-icon name="close-circle" slot="start" color="danger"></ion-icon>
        <ion-label>
          <h2>{{ product.name }}</h2>
          <p>Product is out of stock</p>
        </ion-label>
        <ion-button slot="end" fill="solid" color="primary" size="small" (click)="adjustStock(product, 'add')">
          <ion-icon name="add-outline" slot="start"></ion-icon>
          Restock
        </ion-button>
      </ion-item>

      @if (outOfStockProducts().length === 0) {
        <div class="empty-state">
          <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
          <h2>All in stock!</h2>
          <p>No out of stock items</p>
        </div>
      }
    </ion-list>
  }

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p>Loading inventory...</p>
    </div>
  }
</ion-content>
