<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/terminals"></ion-back-button>
    </ion-buttons>
    <ion-title>Tables Management</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" color="light" (click)="openBulkForm()">
        <ion-icon slot="start" name="list-outline"></ion-icon>
        <ion-label>Bulk Tables</ion-label>
      </ion-button>
      <ion-button fill="clear" color="light" (click)="createTable()">
        <ion-icon slot="start" name="add-outline"></ion-icon>
        <ion-label>New Table</ion-label>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="tables-container">
    <div class="tables-filters" *ngIf="sections().length > 0 || filterSection !== 'all'">
      <div class="filters-label">Filter by section</div>
      <ion-segment [(ngModel)]="filterSection" (ionChange)="filterTables()">
        <ion-segment-button value="all">
          <ion-label>All</ion-label>
        </ion-segment-button>
        <ion-segment-button value="unassigned">
          <ion-label>Unassigned</ion-label>
        </ion-segment-button>
        @for (section of sections(); track section) {
          <ion-segment-button [value]="section">
            <ion-label>{{ section }}</ion-label>
          </ion-segment-button>
        }
      </ion-segment>
    </div>
    @if (filteredTables().length === 0) {
      <div class="empty-state">
        <ion-icon name="restaurant-outline"></ion-icon>
        <h2>No Tables Found</h2>
        <p>{{ filterSection === 'all' ? 'Create your first table to get started' : 'No tables in this section' }}</p>
        @if (filterSection === 'all') {
          <ion-button color="primary" (click)="createTable()">
            <ion-icon slot="start" name="add-outline"></ion-icon>
            Create Table
          </ion-button>
          <ion-button fill="outline" color="primary" (click)="openBulkForm()">
            <ion-icon slot="start" name="list-outline"></ion-icon>
            Bulk Create Tables
          </ion-button>
        }
      </div>
    } @else {
      <!-- Table Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <ion-icon name="restaurant-outline" color="primary"></ion-icon>
          <div class="stat-info">
            <span class="stat-value">{{ tables().length }}</span>
            <span class="stat-label">Total Tables</span>
          </div>
        </div>
        <div class="stat-card">
          <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
          <div class="stat-info">
            <span class="stat-value">{{ getTablesByStatus('free').length }}</span>
            <span class="stat-label">Available</span>
          </div>
        </div>
        <div class="stat-card">
          <ion-icon name="people-outline" color="warning"></ion-icon>
          <div class="stat-info">
            <span class="stat-value">{{ getTablesByStatus('occupied').length }}</span>
            <span class="stat-label">Occupied</span>
          </div>
        </div>
        <div class="stat-card">
          <ion-icon name="time-outline" color="primary"></ion-icon>
          <div class="stat-info">
            <span class="stat-value">{{ getTablesByStatus('reserved').length }}</span>
            <span class="stat-label">Reserved</span>
          </div>
        </div>
      </div>

      <!-- Tables Grid -->
      <div class="tables-grid">
        @for (table of filteredTables(); track table._id) {
          <ion-card [class.occupied]="table.status === 'occupied'" 
                    [class.reserved]="table.status === 'reserved'"
                    [class.cleaning]="table.status === 'cleaning'"
                    [class.inactive]="!table.active">
            <ion-card-header>
              <div class="table-header">
                <div class="table-number">
                  <ion-icon [name]="getShapeIcon(table.shape)"></ion-icon>
                  <div>
                    <ion-card-title>{{ table.number }}</ion-card-title>
                    @if (table.name) {
                      <ion-card-subtitle>{{ table.name }}</ion-card-subtitle>
                    }
                  </div>
                </div>
                <ion-badge [color]="getStatusColor(table.status)">
                  {{ table.status }}
                </ion-badge>
              </div>
            </ion-card-header>

            <ion-card-content>
              <div class="table-details">
                <div class="detail-row">
                  <ion-icon name="people-outline"></ion-icon>
                  <span>Capacity: {{ table.capacity }}</span>
                </div>

                @if (table.section) {
                  <div class="detail-row">
                    <ion-icon name="location-outline"></ion-icon>
                    <span>{{ table.section }}</span>
                  </div>
                }

                @if (table.floor) {
                  <div class="detail-row">
                    <ion-icon name="layers-outline"></ion-icon>
                    <span>Floor {{ table.floor }}</span>
                  </div>
                }

                @if (table.status === 'occupied' && table.guestName) {
                  <div class="detail-row guest-info">
                    <ion-icon name="person-outline" color="primary"></ion-icon>
                    <span>{{ table.guestName }} ({{ table.guestCount || 0 }} guests)</span>
                  </div>
                }

                @if (table.waiterName) {
                  <div class="detail-row">
                    <ion-icon name="person-circle-outline"></ion-icon>
                    <span>Waiter: {{ table.waiterName }}</span>
                  </div>
                }

                @if (table.amount > 0) {
                  <div class="detail-row amount-info">
                    <ion-icon name="cash-outline" color="success"></ion-icon>
                    <span>K{{ table.amount.toFixed(2) }}</span>
                  </div>
                }
              </div>

              <div class="table-actions">
                <ion-button size="small" fill="outline" (click)="editTable(table)">
                  <ion-icon slot="start" name="create-outline"></ion-icon>
                  Edit
                </ion-button>

                <ion-button
                  size="small"
                  fill="outline"
                  color="medium"
                  *ngIf="table.section"
                  (click)="clearSection(table)">
                  <ion-icon slot="start" name="remove-outline"></ion-icon>
                  Unassign
                </ion-button>

                @if (table.status === 'free') {
                  <ion-button size="small" fill="solid" color="success" (click)="occupyTable(table)">
                    <ion-icon slot="start" name="person-add-outline"></ion-icon>
                    Seat Guests
                  </ion-button>
                } @else if (table.status === 'occupied') {
                  <ion-button size="small" fill="solid" color="primary" (click)="viewTableOrder(table)">
                    <ion-icon slot="start" name="receipt-outline"></ion-icon>
                    View Order
                  </ion-button>
                  <ion-button size="small" fill="outline" color="danger" (click)="clearTable(table)">
                    <ion-icon slot="start" name="close-outline"></ion-icon>
                    Clear
                  </ion-button>
                }

                <ion-button 
                  size="small" 
                  [fill]="table.active ? 'solid' : 'outline'"
                  [color]="table.active ? 'medium' : 'success'"
                  (click)="toggleActive(table)">
                  {{ table.active ? 'Deactivate' : 'Activate' }}
                </ion-button>

                <ion-button size="small" fill="outline" color="danger" (click)="deleteTable(table)">
                  <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>
        }
      </div>
    }
  </div>
</ion-content>

<!-- Create/Edit Table Modal -->
<ion-modal [isOpen]="showTableForm()" (didDismiss)="closeTableForm()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>{{ formMode === 'create' ? 'Create Table' : 'Edit Table' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button color="light" (click)="closeTableForm()">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <div class="table-form">
        <ion-list lines="full">
          <ion-item>
            <ion-label position="stacked">Table Number *</ion-label>
            <ion-input [(ngModel)]="tableForm.number" placeholder="e.g. T1, T2"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Table Name</ion-label>
            <ion-input [(ngModel)]="tableForm.name" placeholder="Optional name"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Capacity *</ion-label>
            <ion-input type="number" min="1" [(ngModel)]="tableForm.capacity"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Section</ion-label>
            <ion-input [(ngModel)]="tableForm.section" placeholder="e.g. Main Floor, Terrace"></ion-input>
          </ion-item>

          @if (sections().length > 0) {
            <div class="section-suggestions">
              <div class="section-suggestions-label">Existing sections</div>
              <div class="section-suggestions-chips">
                @for (section of sections(); track section) {
                  <ion-chip (click)="tableForm.section = section" [outline]="tableForm.section !== section">
                    <ion-label>{{ section }}</ion-label>
                  </ion-chip>
                }
              </div>
            </div>
          }

          <ion-item>
            <ion-label position="stacked">Floor</ion-label>
            <ion-input type="number" min="1" [(ngModel)]="tableForm.floor"></ion-input>
          </ion-item>
        </ion-list>

        <div class="shape-choices">
          <div class="shape-label">Table Shape</div>
          <ion-segment [(ngModel)]="tableForm.shape" color="primary">
            <ion-segment-button value="square">
              <ion-icon name="square-outline"></ion-icon>
              <ion-label>Square</ion-label>
            </ion-segment-button>
            <ion-segment-button value="round">
              <ion-icon name="ellipse-outline"></ion-icon>
              <ion-label>Round</ion-label>
            </ion-segment-button>
            <ion-segment-button value="rectangular">
              <ion-icon name="remove-outline"></ion-icon>
              <ion-label>Rectangular</ion-label>
            </ion-segment-button>
          </ion-segment>
        </div>

        <div class="form-actions">
          <ion-button fill="clear" color="medium" (click)="closeTableForm()">
            Cancel
          </ion-button>
          <ion-button color="primary" (click)="submitTableForm()">
            <ion-icon slot="start" [name]="formMode === 'create' ? 'add-outline' : 'create-outline'"></ion-icon>
            {{ formMode === 'create' ? 'Create Table' : 'Save Changes' }}
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Bulk Create Tables Modal -->
<ion-modal [isOpen]="showBulkForm()" (didDismiss)="closeBulkForm()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Bulk Create Tables</ion-title>
        <ion-buttons slot="end">
          <ion-button color="light" (click)="closeBulkForm()">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <h2>Paste or type your tables</h2>
      <p>
        Use <strong>#Section Name</strong> lines to group tables, followed by one table per line.
        Lines starting with <strong>#</strong> set the current section; other lines are table numbers.
      </p>

      <div class="bulk-example">
        #Main Floor
        T1
        T2
        T3
        T4

        #Pool Side
        P1
        P2
        P3
        P4
      </div>

      <ion-item lines="full">
        <ion-label position="stacked">Bulk table list</ion-label>
        <ion-textarea
          auto-grow="true"
          [(ngModel)]="bulkText"
          placeholder="#Main Floor&#10;T1&#10;T2&#10;T3&#10;T4">
        </ion-textarea>
      </ion-item>

      <div class="form-actions">
        <ion-button fill="clear" color="medium" (click)="closeBulkForm()">
          Cancel
        </ion-button>
        <ion-button color="primary" (click)="submitBulkForm()">
          <ion-icon slot="start" name="list-outline"></ion-icon>
          Create Tables
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
