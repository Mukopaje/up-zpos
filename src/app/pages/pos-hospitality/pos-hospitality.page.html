<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Tables</ion-title>
    <ion-buttons slot="start" *ngIf="isAdmin()">
      <ion-button color="light" (click)="exitToMainPos()">
        <ion-icon name="swap-horizontal-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-chip color="light">
        <ion-icon name="restaurant-outline"></ion-icon>
        <ion-label>{{ occupiedCount() }}/{{ tables().length }}</ion-label>
      </ion-chip>
      <ion-chip color="light">
        <ion-icon name="cash-outline"></ion-icon>
        <ion-label>{{ totalRevenue() | currency:'ZMW':'symbol':'1.0-0' }}</ion-label>
      </ion-chip>
      <ion-button color="light" (click)="viewMode.set(viewMode() === 'grid' ? 'list' : 'grid')">
        <ion-icon [name]="viewMode() === 'grid' ? 'list-outline' : 'grid-outline'" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button color="light" (click)="viewMode.set('grid'); layoutMode.set(layoutMode() === 'service' ? 'layout' : 'service')">
        <ion-icon name="map-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button
        *ngIf="isAdmin() && layoutMode() === 'layout'"
        color="light"
        (click)="toggleLayoutEditing()">
        <ion-icon [name]="editingLayout() ? 'checkmark-outline' : 'create-outline'" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <!-- Section Filter -->
  <ion-toolbar color="light">
    <ion-segment [(ngModel)]="selectedSection" scrollable color="primary">
      @for (section of sections(); track section) {
        <ion-segment-button [value]="section">
          <ion-label>{{ section === 'all' ? 'All' : section }}</ion-label>
        </ion-segment-button>
      }
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content>
  @if (hospitalityContext.movingFromTableId()) {
    <ion-item color="warning" lines="full" class="change-table-banner">
      <ion-label>
        Changing table: tap the new table to move this order.
      </ion-label>
    </ion-item>
  }
  <!-- Layout View (floor plan) -->
  @if (layoutMode() === 'layout') {
    <div class="floor-plan">
      <div
        class="floor-plan-canvas"
        #floorPlanCanvas
        [ngStyle]="{
          'background-image': floorPlanImageUrl() ? 'url(' + floorPlanImageUrl() + ')' : 'none'
        }"
      >
        @for (label of floorLabels(); track label.id) {
          <div
            class="floor-label floor-label-{{ label.type }}"
            [ngStyle]="{ top: (label.y * 100) + '%', left: (label.x * 100) + '%' }"
            (mousedown)="startDragLabel($event, label)"
            (touchstart)="startDragLabel($event, label)"
          >
            <span>{{ label.text || label.type }}</span>
            @if (editingLayout()) {
              <button
                type="button"
                class="remove-label-button"
                (click)="removeLabel(label.id); $event.stopPropagation()">
                ×
              </button>
            }
          </div>
        }

        @for (table of filteredTables(); track table._id) {
          <button
            type="button"
            class="floor-table status-{{ table.status }}"
            [ngStyle]="getLayoutStyle(table)"
            (click)="onTableClick(table)"
            (mousedown)="startDragTable($event, table)"
            (touchstart)="startDragTable($event, table)"
          >
            <div class="floor-table-number">{{ table.number }}</div>
            @if (table.name) {
              <div class="floor-table-name">{{ table.name }}</div>
            }
          </button>
        }
      </div>

      @if (isAdmin() && editingLayout()) {
        <div class="layout-edit-panel ion-padding">
          <ion-item lines="none">
            <ion-label position="stacked">Add floor label</ion-label>
            <ion-select [(ngModel)]="labelType" interface="popover">
              <ion-select-option value="door">Door</ion-select-option>
              <ion-select-option value="counter">Counter</ion-select-option>
              <ion-select-option value="bar">Bar</ion-select-option>
              <ion-select-option value="restroom">Restroom</ion-select-option>
              <ion-select-option value="custom">Custom</ion-select-option>
            </ion-select>
            <ion-input
              class="layout-label-text"
              placeholder="Label text (optional)"
              [(ngModel)]="labelText">
            </ion-input>
            <ion-button size="small" color="primary" (click)="addLabel()">
              <ion-icon slot="start" name="add-outline"></ion-icon>
              Add
            </ion-button>
          </ion-item>
          <ion-item lines="none" class="layout-image-row">
            <ion-label position="stacked">Floor plan image</ion-label>
            <div class="layout-image-controls">
              <div class="layout-image-preview" *ngIf="floorPlanImageUrl()">
                <img [src]="floorPlanImageUrl()" alt="Floor plan preview" />
              </div>
              <div class="layout-image-buttons">
                <input
                  #floorImageInput
                  type="file"
                  accept="image/*"
                  (change)="onFloorImageFileSelected($event)"
                  hidden
                />
                <ion-button size="small" color="primary" (click)="triggerFloorImagePicker(floorImageInput)">
                  <ion-icon slot="start" name="image-outline"></ion-icon>
                  Choose Image
                </ion-button>
                <ion-button size="small" color="medium" fill="outline" (click)="clearFloorImage()" [disabled]="!floorPlanImageUrl()">
                  Clear
                </ion-button>
              </div>
            </div>
          </ion-item>
          <ion-text color="medium">
            <p>Drag tables and labels to reposition them, then tap the pen icon to finish editing.</p>
          </ion-text>
        </div>
      }
    </div>
  }

  <!-- Grid View -->
  @if (layoutMode() === 'service' && viewMode() === 'grid') {
    @if (filteredTables().length === 0) {
      <div class="hospitality-empty">
        <ion-icon name="restaurant-outline"></ion-icon>
        <h2>No tables configured</h2>
        <p>Use Tables Management to create tables for this terminal.</p>
        @if (isAdmin()) {
          <ion-button color="primary" (click)="goToTablesManagement()">
            <ion-icon slot="start" name="create-outline"></ion-icon>
            Manage Tables
          </ion-button>
        } @else {
          <ion-text color="medium">
            <p>Ask your administrator to configure tables.</p>
          </ion-text>
        }
      </div>
    } @else {
      <ion-grid class="tables-grid">
        <ion-row>
          @for (table of filteredTables(); track table._id) {
            <ion-col size="6" sizeMd="4" sizeLg="3">
              <ion-card 
              [class]="'table-card status-' + table.status"
              (click)="selectTable(table)"
              button
            >
              <ion-card-header>
                <div class="table-header">
                  <ion-card-title>{{ table.number }}</ion-card-title>
                  <ion-badge [color]="getTableStatusColor(table.status)">
                    {{ table.status }}
                  </ion-badge>
                </div>
                @if (table.name) {
                  <p class="table-name">{{ table.name }}</p>
                }
              </ion-card-header>
              
              <ion-card-content>
                @if (table.status === 'occupied') {
                  <div class="table-info">
                    <div class="info-row">
                      <ion-icon name="person-outline"></ion-icon>
                      <span>{{ table.guestName }}</span>
                    </div>
                    <div class="info-row">
                      <ion-icon name="people-outline"></ion-icon>
                      <span>{{ table.guestCount }} guests</span>
                    </div>
                    @if (table.waiterName) {
                      <div class="info-row">
                        <ion-icon name="restaurant-outline"></ion-icon>
                        <span>{{ table.waiterName }}</span>
                      </div>
                    }
                    <div class="info-row">
                      <ion-icon name="time-outline"></ion-icon>
                      <span>{{ getElapsedTime(table.startTime!) }}</span>
                    </div>
                    <div class="amount">
                      {{ table.amount | currency:'ZMW':'symbol':'1.2-2' }}
                    </div>
                  </div>
                } @else {
                  <div class="empty-table">
                    <ion-icon name="checkmark-outline" size="large"></ion-icon>
                    <p>Available</p>
                  </div>
                }
              </ion-card-content>
            </ion-card>
          </ion-col>
        }
      </ion-row>
    </ion-grid>
    }
  }
  
  <!-- List View -->
  @if (layoutMode() === 'service' && viewMode() === 'list') {
    <ion-list>
      @for (table of filteredTables(); track table._id) {
        <ion-item button (click)="selectTable(table)">
          <ion-icon [name]="getTableIcon(table)" slot="start"></ion-icon>
          <ion-label>
            <h2>{{ table.number }} @if (table.name) {<span class="table-name-inline">- {{ table.name }}</span>}</h2>
            @if (table.status === 'occupied') {
              <p>{{ table.guestName }} ({{ table.guestCount }}) • {{ table.waiterName }}</p>
              <p>{{ getElapsedTime(table.startTime!) }}</p>
            }
          </ion-label>
          <div slot="end" class="table-end">
            <ion-badge [color]="getTableStatusColor(table.status)">{{ table.status }}</ion-badge>
            @if (table.status === 'occupied') {
              <div class="amount">{{ table.amount | currency:'ZMW':'symbol':'1.0-0' }}</div>
            }
          </div>
        </ion-item>
      }
    </ion-list>
  }
</ion-content>

<!-- Occupy Table Modal -->
<ion-modal #occupyTableModal [isOpen]="showTableModal()" (didDismiss)="closeOccupyTableModal()" cssClass="occupy-table-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Open Table {{ selectedTable()?.number }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeOccupyTableModal()">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="ion-padding">
      <ion-item>
        <ion-label position="stacked">Guest Name (optional)</ion-label>
        <ion-input [(ngModel)]="guestName" placeholder="Enter guest name (optional)"></ion-input>
      </ion-item>
      
      <ion-item>
        <ion-label position="stacked">Number of Guests *</ion-label>
        <ion-input type="number" [(ngModel)]="guestCount" min="1"></ion-input>
      </ion-item>
      
      @if (!loggedInWaiter) {
        <ion-item>
          <ion-label position="stacked">Assign Waiter</ion-label>
          <ion-select [(ngModel)]="selectedWaiterId" placeholder="Select waiter">
            @for (waiter of waiters(); track waiter._id) {
              <ion-select-option [value]="waiter._id">{{ waiter.name }}</ion-select-option>
            }
          </ion-select>
        </ion-item>
      } @else {
        <ion-item>
          <ion-label position="stacked">Waiter</ion-label>
          <ion-label>{{ loggedInWaiter.name }}</ion-label>
        </ion-item>
      }
      
      <ion-item>
        <ion-label position="stacked">Notes</ion-label>
        <ion-textarea [(ngModel)]="tableNotes" placeholder="Any special requests..."></ion-textarea>
      </ion-item>
      
      <ion-button
        expand="block"
        color="success"
        class="ion-margin-top"
        (click)="occupyTable()"
        [disabled]="guestCount() < 1">
        <ion-icon name="checkmark-outline" slot="start"></ion-icon>
        Open Table
      </ion-button>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Order Modal -->
<ion-modal [isOpen]="showNewOrderModal()" (didDismiss)="closeModals()" class="order-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Table {{ selectedTable()?.number }} - {{ selectedTable()?.guestName }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeModals()">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
      
      <!-- Category Filter -->
      <ion-toolbar>
        <ion-segment [(ngModel)]="selectedCategory" scrollable>
          @for (cat of categories(); track cat) {
            <ion-segment-button [value]="cat">
              <ion-label>{{ cat === 'all' ? 'All' : cat }}</ion-label>
            </ion-segment-button>
          }
        </ion-segment>
      </ion-toolbar>
    </ion-header>
    
    <ion-content>
      <div class="order-content">
        <!-- Products Grid -->
        <div class="products-section">
          <ion-grid>
            <ion-row>
              @for (product of filteredProducts(); track product._id) {
                <ion-col size="6" sizeMd="4" sizeLg="3">
                  <ion-card button (click)="addProductToOrder(product)" class="product-card">
                    <ion-card-content>
                      <div class="product-name">{{ product.name }}</div>
                      <div class="product-price">{{ product.price | currency:'ZMW':'symbol':'1.2-2' }}</div>
                      @if (product.courseType) {
                        <ion-badge size="small">{{ product.courseType }}</ion-badge>
                      }
                    </ion-card-content>
                  </ion-card>
                </ion-col>
              }
            </ion-row>
          </ion-grid>
        </div>
        
        <!-- Order Items -->
        <div class="order-section">
          <h3>Order Items ({{ orderItems().length }})</h3>
          
          @if (orderItems().length === 0) {
            <div class="empty-order">
              <p>Select products to add to order</p>
            </div>
          } @else {
            <ion-list>
              @for (item of orderItems(); track $index) {
                <ion-item>
                  <ion-label>
                    <h3>{{ item.name }}</h3>
                    @if (item.sentToKitchen) {
                      <ion-badge color="success">Sent to Kitchen</ion-badge>
                    }
                  </ion-label>
                  
                  <div slot="end" class="item-controls">
                    <ion-button size="small" fill="clear" (click)="updateOrderQuantity($index, item.quantity - 1)">
                      <ion-icon name="remove-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                    <span class="quantity">{{ item.quantity }}</span>
                    <ion-button size="small" fill="clear" (click)="updateOrderQuantity($index, item.quantity + 1)">
                      <ion-icon name="add-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                    <span class="item-total">{{ item.total | currency:'ZMW':'symbol':'1.2-2' }}</span>
                    <ion-button size="small" fill="clear" color="danger" (click)="removeOrderItem($index)">
                      <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>
                </ion-item>
              }
            </ion-list>
            
            <div class="order-total">
              <span>Total:</span>
              <span class="total-amount">{{ orderTotal() | currency:'ZMW':'symbol':'1.2-2' }}</span>
            </div>
          }
        </div>
      </div>
    </ion-content>
    
    <ion-footer>
        <div class="order-actions">
          <ion-button expand="block" color="primary" (click)="sendToKitchen()" [disabled]="orderItems().length === 0">
            <ion-icon name="send-outline" slot="start"></ion-icon>
            Close &amp; Send
          </ion-button>
          <ion-button expand="block" fill="outline" (click)="saveOrder()" [disabled]="orderItems().length === 0">
            Save Order
          </ion-button>
          <ion-button expand="block" color="success" (click)="openCheckout(selectedTable()!)" [disabled]="!selectedTable() || selectedTable()?.amount === 0">
            <ion-icon name="cash-outline" slot="start"></ion-icon>
            Checkout
          </ion-button>
        </div>
    </ion-footer>
  </ng-template>
</ion-modal>

<!-- Floating Action Buttons -->
@if (selectedTable() && selectedTable()?.status === 'occupied') {
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button color="success" (click)="openCheckout(selectedTable()!)">
      <ion-icon name="cash-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
}
