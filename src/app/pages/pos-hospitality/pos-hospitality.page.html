<ion-header>
  <ion-toolbar>
    <ion-title>Tables</ion-title>
    <ion-buttons slot="end">
      <ion-chip>
        <ion-icon name="restaurant-outline"></ion-icon>
        <ion-label>{{ occupiedCount() }}/{{ tables().length }}</ion-label>
      </ion-chip>
      <ion-chip color="success">
        <ion-icon name="cash-outline"></ion-icon>
        <ion-label>{{ totalRevenue() | currency:'ZMW':'symbol':'1.0-0' }}</ion-label>
      </ion-chip>
      <ion-button (click)="viewMode.set(viewMode() === 'grid' ? 'list' : 'grid')">
        <ion-icon [name]="viewMode() === 'grid' ? 'list-outline' : 'grid-outline'" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <!-- Section Filter -->
  <ion-toolbar>
    <ion-segment [(ngModel)]="selectedSection" scrollable>
      @for (section of sections(); track section) {
        <ion-segment-button [value]="section">
          <ion-label>{{ section === 'all' ? 'All' : section }}</ion-label>
        </ion-segment-button>
      }
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Grid View -->
  @if (viewMode() === 'grid') {
    <ion-grid class="tables-grid">
      <ion-row>
        @for (table of filteredTables(); track table._id) {
          <ion-col size="6" sizeMd="4" sizeLg="3">
            <ion-card 
              [class]="'table-card status-' + table.status"
              (click)="selectTable(table)"
              button
            >
              <ion-card-header>
                <div class="table-header">
                  <ion-card-title>{{ table.number }}</ion-card-title>
                  <ion-badge [color]="getTableStatusColor(table.status)">
                    {{ table.status }}
                  </ion-badge>
                </div>
                @if (table.name) {
                  <p class="table-name">{{ table.name }}</p>
                }
              </ion-card-header>
              
              <ion-card-content>
                @if (table.status === 'occupied') {
                  <div class="table-info">
                    <div class="info-row">
                      <ion-icon name="person-outline"></ion-icon>
                      <span>{{ table.guestName }}</span>
                    </div>
                    <div class="info-row">
                      <ion-icon name="people-outline"></ion-icon>
                      <span>{{ table.guestCount }} guests</span>
                    </div>
                    @if (table.waiterName) {
                      <div class="info-row">
                        <ion-icon name="restaurant-outline"></ion-icon>
                        <span>{{ table.waiterName }}</span>
                      </div>
                    }
                    <div class="info-row">
                      <ion-icon name="time-outline"></ion-icon>
                      <span>{{ getElapsedTime(table.startTime!) }}</span>
                    </div>
                    <div class="amount">
                      {{ table.amount | currency:'ZMW':'symbol':'1.2-2' }}
                    </div>
                  </div>
                } @else {
                  <div class="empty-table">
                    <ion-icon name="checkmark-outline" size="large"></ion-icon>
                    <p>Available</p>
                  </div>
                }
              </ion-card-content>
            </ion-card>
          </ion-col>
        }
      </ion-row>
    </ion-grid>
  }
  
  <!-- List View -->
  @if (viewMode() === 'list') {
    <ion-list>
      @for (table of filteredTables(); track table._id) {
        <ion-item button (click)="selectTable(table)">
          <ion-icon [name]="getTableIcon(table)" slot="start"></ion-icon>
          <ion-label>
            <h2>{{ table.number }} @if (table.name) {<span class="table-name-inline">- {{ table.name }}</span>}</h2>
            @if (table.status === 'occupied') {
              <p>{{ table.guestName }} ({{ table.guestCount }}) • {{ table.waiterName }}</p>
              <p>{{ getElapsedTime(table.startTime!) }}</p>
            }
          </ion-label>
          <div slot="end" class="table-end">
            <ion-badge [color]="getTableStatusColor(table.status)">{{ table.status }}</ion-badge>
            @if (table.status === 'occupied') {
              <div class="amount">{{ table.amount | currency:'ZMW':'symbol':'1.0-0' }}</div>
            }
          </div>
        </ion-item>
      }
    </ion-list>
  }
</ion-content>

<!-- Occupy Table Modal -->
<ion-modal [isOpen]="showTableModal()" (didDismiss)="closeModals()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Open Table {{ selectedTable()?.number }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeModals()">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="ion-padding">
      <ion-item>
        <ion-label position="stacked">Guest Name *</ion-label>
        <ion-input [(ngModel)]="guestName" placeholder="Enter guest name"></ion-input>
      </ion-item>
      
      <ion-item>
        <ion-label position="stacked">Number of Guests *</ion-label>
        <ion-input type="number" [(ngModel)]="guestCount" min="1"></ion-input>
      </ion-item>
      
      <ion-item>
        <ion-label position="stacked">Assign Waiter</ion-label>
        <ion-select [(ngModel)]="selectedWaiterId" placeholder="Select waiter">
          @for (waiter of waiters(); track waiter._id) {
            <ion-select-option [value]="waiter._id">{{ waiter.name }}</ion-select-option>
          }
        </ion-select>
      </ion-item>
      
      <ion-item>
        <ion-label position="stacked">Notes</ion-label>
        <ion-textarea [(ngModel)]="tableNotes" placeholder="Any special requests..."></ion-textarea>
      </ion-item>
      
      <ion-button expand="block" class="ion-margin-top" (click)="occupyTable()" [disabled]="!guestName() || guestCount() < 1">
        <ion-icon name="checkmark-outline" slot="start"></ion-icon>
        Open Table
      </ion-button>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Order Modal -->
<ion-modal [isOpen]="showNewOrderModal()" (didDismiss)="closeModals()" class="order-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Table {{ selectedTable()?.number }} - {{ selectedTable()?.guestName }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeModals()">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
      
      <!-- Category Filter -->
      <ion-toolbar>
        <ion-segment [(ngModel)]="selectedCategory" scrollable>
          @for (cat of categories(); track cat) {
            <ion-segment-button [value]="cat">
              <ion-label>{{ cat === 'all' ? 'All' : cat }}</ion-label>
            </ion-segment-button>
          }
        </ion-segment>
      </ion-toolbar>
    </ion-header>
    
    <ion-content>
      <div class="order-content">
        <!-- Products Grid -->
        <div class="products-section">
          <ion-grid>
            <ion-row>
              @for (product of filteredProducts(); track product._id) {
                <ion-col size="6" sizeMd="4" sizeLg="3">
                  <ion-card button (click)="addProductToOrder(product)" class="product-card">
                    <ion-card-content>
                      <div class="product-name">{{ product.name }}</div>
                      <div class="product-price">{{ product.price | currency:'ZMW':'symbol':'1.2-2' }}</div>
                      @if (product.courseType) {
                        <ion-badge size="small">{{ product.courseType }}</ion-badge>
                      }
                    </ion-card-content>
                  </ion-card>
                </ion-col>
              }
            </ion-row>
          </ion-grid>
        </div>
        
        <!-- Order Items -->
        <div class="order-section">
          <h3>Order Items ({{ orderItems().length }})</h3>
          
          @if (orderItems().length === 0) {
            <div class="empty-order">
              <p>Select products to add to order</p>
            </div>
          } @else {
            <ion-list>
              @for (item of orderItems(); track $index) {
                <ion-item>
                  <ion-label>
                    <h3>{{ item.name }}</h3>
                    @if (item.sentToKitchen) {
                      <ion-badge color="success">Sent to Kitchen</ion-badge>
                    }
                  </ion-label>
                  
                  <div slot="end" class="item-controls">
                    <ion-button size="small" fill="clear" (click)="updateOrderQuantity($index, item.quantity - 1)">
                      <ion-icon name="remove-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                    <span class="quantity">{{ item.quantity }}</span>
                    <ion-button size="small" fill="clear" (click)="updateOrderQuantity($index, item.quantity + 1)">
                      <ion-icon name="add-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                    <span class="item-total">{{ item.total | currency:'ZMW':'symbol':'1.2-2' }}</span>
                    <ion-button size="small" fill="clear" color="danger" (click)="removeOrderItem($index)">
                      <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>
                </ion-item>
              }
            </ion-list>
            
            <div class="order-total">
              <span>Total:</span>
              <span class="total-amount">{{ orderTotal() | currency:'ZMW':'symbol':'1.2-2' }}</span>
            </div>
          }
        </div>
      </div>
    </ion-content>
    
    <ion-footer>
      <div class="order-actions">
        <ion-button expand="block" color="primary" (click)="sendToKitchen()" [disabled]="orderItems().length === 0">
          <ion-icon name="send-outline" slot="start"></ion-icon>
          Send to Kitchen
        </ion-button>
        <ion-button expand="block" fill="outline" (click)="saveOrder()" [disabled]="orderItems().length === 0">
          Save Order
        </ion-button>
      </div>
    </ion-footer>
  </ng-template>
</ion-modal>

<!-- Checkout Modal -->
<ion-modal [isOpen]="showCheckoutModal()" (didDismiss)="closeModals()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Checkout - Table {{ selectedTable()?.number }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeModals()">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="ion-padding">
      <div class="checkout-summary">
        <div class="guest-info">
          <h3>{{ selectedTable()?.guestName }}</h3>
          <p>{{ selectedTable()?.guestCount }} guests • {{ selectedTable()?.waiterName }}</p>
        </div>
        
        <div class="amount-due">
          <span>Amount Due</span>
          <div class="amount">{{ selectedTable()?.amount | currency:'ZMW':'symbol':'1.2-2' }}</div>
        </div>
        
        <ion-item>
          <ion-label position="stacked">Payment Method</ion-label>
          <ion-select [(ngModel)]="paymentMethod">
            <ion-select-option value="cash">Cash</ion-select-option>
            <ion-select-option value="card">Card</ion-select-option>
            <ion-select-option value="mobile">Mobile Money</ion-select-option>
            <ion-select-option value="account">Account</ion-select-option>
          </ion-select>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Amount Paid</ion-label>
          <ion-input type="number" [(ngModel)]="amountPaid"></ion-input>
        </ion-item>
        
        @if (amountPaid() > (selectedTable()?.amount || 0)) {
          <div class="change-display">
            <span>Change:</span>
            <span class="change">{{ amountPaid() - (selectedTable()?.amount || 0) | currency:'ZMW':'symbol':'1.2-2' }}</span>
          </div>
        }
      </div>
      
      <ion-button expand="block" color="success" class="ion-margin-top" (click)="completePayment()" [disabled]="amountPaid() < (selectedTable()?.amount || 0)">
        <ion-icon name="checkmark-outline" slot="start"></ion-icon>
        Complete Payment
      </ion-button>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Floating Action Buttons -->
@if (selectedTable() && selectedTable()?.status === 'occupied') {
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button color="success" (click)="openCheckout(selectedTable()!)">
      <ion-icon name="cash-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
}
